# yume-pdq

A hand-vectorized implementation of the Facebook Perceptual Hash ([PDQ](https://github.com/facebook/ThreatExchange/tree/main/pdq)) estimation algorithm that prioritizes throughput over precision.

Warning: This should be fully functional to my standards, but I am holding off publishing it to crates.io for a few days to finalize some design decisions.

TODO: Write a piping binary suitable for ffmpeg.

## Design Goals

Be _accurate enough_ for high-throughput screening. At present, the official docs require 10 bits when quality > 0.8 to be considered "correct" and we are currently right on the border (see [Accuracy on test set](#accuracy-on-test-set)). However the threshold for matching is 31 bits so we consider this not important for the purpose of matching.

Parallelize well up to the memory bandwidth limit.

Not bit-identical to the reference implementation.

Zero dependencies in the final binary (including statically linked crates).

No-std support.

## Benchmark

Generated by criterion on an AMD Ryzen 9 7950X (Zen 4) with two 32GiB DDR5 6000MT/s RAM, empty cells below means there are no hand-tuned implementation for that operation.

|                                                             |                                                 |
| ----------------------------------------------------------- | ----------------------------------------------- |
| ![Benchmark overall operations](bench-plot/overall_ops.jpg) | ![Benchmark overall](bench-plot/overall.jpg)    |
| ![Benchmark sub-operations](bench-plot/sub.jpg)             | ![Benchmark hash-flipping](bench-plot/flip.jpg) |



## Accuracy on test set

The accuracy was done by writing unit tests that do pairwise comparison with either the "pdqhash" high level API or the 32-bit floating point reference implementation or the 96-bit floating point reference implementation.

Note higher distance to the `pdqhash` library is expected as they have mandatory preprocessing steps that cannot be slipped by the exposed API. The "reference" implementation is a more faithful pairwise comparison.

| Image                                                 | Kernel  | Distance vs pdqhash lib | Quality | Distance vs Ref32 | Distance vs Ref96 |
| ----------------------------------------------------- | ------- | ----------------------- | ------- | ----------------- | ----------------- |
| aaa-orig.jpg (real photo, official test vector)       | AVX2    | 6/256 (2.3%)            | 0.966   | 4/256 (1.6%)      | 4/256 (1.6%)      |
|                                                       | AVX512  | 6/256 (2.3%)            | 0.966   | 4/256 (1.6%)      | 4/256 (1.6%)      |
|                                                       | Default | 6/256 (2.3%)            | 0.966   | 4/256 (1.6%)      | 4/256 (1.6%)      |
|                                                       | Ref32   | 6/256 (2.3%)            | 0.966   | -                 | 0/256 (0.0%)      |
| anime.png (it's anime)                                | AVX2    | 16/256 (6.2%)           | 0.556   | 10/256 (3.9%)     | 10/256 (3.9%)     |
|                                                       | AVX512  | 16/256 (6.2%)           | 0.556   | 10/256 (3.9%)     | 10/256 (3.9%)     |
|                                                       | Default | 16/256 (6.2%)           | 0.556   | 10/256 (3.9%)     | 10/256 (3.9%)     |
|                                                       | Ref32   | 16/256 (6.2%)           | 0.556   | -                 | 0/256 (0.0%)      |
| music.png (Music Video screenshot)                    | AVX2    | 10/256 (3.9%)           | 0.493   | 8/256 (3.1%)      | 8/256 (3.1%)      |
|                                                       | AVX512  | 10/256 (3.9%)           | 0.493   | 8/256 (3.1%)      | 8/256 (3.1%)      |
|                                                       | Default | 10/256 (3.9%)           | 0.493   | 8/256 (3.1%)      | 8/256 (3.1%)      |
|                                                       | Ref32   | 10/256 (3.9%)           | 0.493   | -                 | 0/256 (0.0%)      |
| neofetch.png (neofetch screenshot, low-entropy image) | AVX2    | 27/256 (10.5%)          | 0.642   | 10/256 (3.9%)     | 11/256 (4.3%)     |
|                                                       | AVX512  | 27/256 (10.5%)          | 0.642   | 10/256 (3.9%)     | 11/256 (4.3%)     |
|                                                       | Default | 26/256 (10.2%)          | 0.642   | 10/256 (3.9%)     | 10/256 (3.9%)     |
|                                                       | Ref32   | -                       | 0.637   | -                 | 0/256 (0.0%)      |



### Implementation Notes

All implementations (Default, AVX2, and AVX512) show excellent numerical stability and consistency:

1. **Accuracy**: 
   - All implementations maintain very high precision, with quality scores matching to ~6 decimal places
   - Differences vs reference implementation are consistently smaller than vs the original library
   - This suggests our implementation achieves better numerical accuracy

2. **Consistency**:
   - AVX2 and AVX512 implementations show identical results for most test cases
   - Quality scores remain extremely consistent across all implementations
   - Minor variations only appear in edge cases (e.g., neofetch.png)

3. **Numerical Stability**:
   - Multiple accumulator strategy ensures high precision
   - Vectorized implementations maintain accuracy while delivering significant performance gains
   - Careful handling of floating-point operations preserves precision in SIMD lanes

The differences versus the original library implementation are likely due to improved numerical precision in our summation methods, particularly in the vectorized implementations.

[yume_pdq::kernel::x86::Avx2F32Kernel (f32)] aaa-orig.jpg: Distance vs. library: 6/256 (Qin=1, Qout=0.96573615)
[yume_pdq::kernel::x86::Avx512F32Kernel (f32)] aaa-orig.jpg: Distance vs. library: 6/256 (Qin=1, Qout=0.9657364)
[yume_pdq::kernel::DefaultKernel (f32)] aaa-orig.jpg: Distance vs. library: 6/256 (Qin=1, Qout=0.96573615)
[yume_pdq::kernel::x86::Avx512F32Kernel (f32)] anime.png: Distance vs. library: 16/256 (Qin=1, Qout=0.55569905)
[yume_pdq::kernel::x86::Avx2F32Kernel (f32)] anime.png: Distance vs. library: 16/256 (Qin=1, Qout=0.55569893)
[yume_pdq::kernel::DefaultKernel (f32)] anime.png: Distance vs. library: 16/256 (Qin=1, Qout=0.5556989)
[yume_pdq::kernel::x86::Avx512F32Kernel (f32)] music.png: Distance vs. library: 10/256 (Qin=1, Qout=0.49306482)
[yume_pdq::kernel::x86::Avx2F32Kernel (f32)] music.png: Distance vs. library: 10/256 (Qin=1, Qout=0.4930647)
[yume_pdq::kernel::DefaultKernel (f32)] music.png: Distance vs. library: 10/256 (Qin=1, Qout=0.4930647)
[yume_pdq::kernel::x86::Avx512F32Kernel (f32)] neofetch.png: Distance vs. library: 27/256 (Qin=1, Qout=0.64156395)
test tests::test_hash_impl_avx512 ... ok
[yume_pdq::kernel::x86::Avx2F32Kernel (f32)] neofetch.png: Distance vs. library: 27/256 (Qin=1, Qout=0.64156365)
test tests::test_hash_impl_avx2 ... ok
[yume_pdq::kernel::DefaultKernel (f32)] neofetch.png: Distance vs. library: 26/256 (Qin=1, Qout=0.64156365)
[yume_pdq::kernel::DefaultKernel (f32)] aaa-orig.jpg: Distance vs. reference: 4/256 (Q=0.9706061)
[yume_pdq::kernel::DefaultKernel (f32)] anime.png: Distance vs. reference: 10/256 (Q=0.5578233)
[yume_pdq::kernel::DefaultKernel (f32)] music.png: Distance vs. reference: 8/256 (Q=0.4926448)

## License and attributions

This crate is licensed under the Apache 2.0 license.

Special thanks to [@darwinium-com](https://github/darwinium-com) for their [pdqhash](https://crates.io/crates/pdqhash) crate, which was a great source of inspiration and the reference kernel
was ~~shamelessly~~ copied almost verbatim from them.

> If it works why rewrite it?
>
> \- Me, probably